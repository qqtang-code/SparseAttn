import torch
import torch.nn.functional as F

# 假设你已将两个 tensor 复制为字符串并转为变量
# 这里我用 eval + ast.literal_eval 模拟（实际你直接贴 tensor 即可）

from ast import literal_eval
import re

def str_to_tensor(s):
    # 清理并转换
    s = re.sub(r'([+-]?\d+\.\d+e[+-]\d+)', r'\1', s)  # 保留科学计数
    s = s.replace('tensor', '').replace('device=\'cuda:0\'', '').replace('dtype=torch.bfloat16', '')
    s = re.sub(r'\s+', ' ', s).strip()
    # 替换 bfloat16 为 float32 以便 eval（不支持 bfloat16 literal）
    s = s.replace('e+00', 'e+0').replace('e-00', 'e-0')  # optional
    arr = literal_eval(s)
    t = torch.tensor(arr, dtype=torch.float32)  # float32 for analysis
    return t


logits1 = torch.tensor([[[-5.0000e+00,  2.5156e+00,  1.6875e+00,  3.2500e+00, -5.5312e+00,
           3.9844e-01,  1.9531e-01,  2.0156e+00,  5.6250e-01, -8.2422e-01,
          -1.5391e+00,  1.3047e+00,  9.4922e-01,  1.0781e+00,  8.3008e-02,
           1.2988e-01, -5.6250e-01, -2.5000e-01,  7.5391e-01, -1.4688e+00,
           5.0000e-01, -1.1641e+00, -6.3281e-01,  2.5000e+00,  5.0354e-03,
           5.5078e-01, -5.0000e-01, -2.6094e+00, -9.0820e-02, -1.2109e+00,
          -9.5625e+00, -1.2031e+00,  1.4453e+00,  6.8750e-01,  4.8242e-01,
          -5.1953e-01, -9.0625e+00,  2.2095e-02,  8.1250e-01,  1.4297e+00,
           7.3828e-01, -7.9688e-01, -3.8867e-01, -6.2891e-01,  6.1719e-01,
           5.5859e-01,  4.1797e-01,  4.0625e-01,  1.0938e+00, -8.3496e-02,
           3.0273e-01, -1.1200e+02,  2.1289e-01,  5.1562e-01,  8.9453e-01,
          -1.9922e-01, -4.4727e-01, -7.9688e-01, -5.4688e-01,  1.0703e+00,
           6.9141e-01,  3.8867e-01,  8.3594e-01,  1.4531e+00,  5.0312e+00,
          -4.7500e+00,  2.5000e+00, -6.5625e-01, -1.0781e+00,  8.9453e-01,
          -9.5312e-01, -9.4922e-01, -1.2812e+00,  8.5547e-01,  1.3594e+00,
           2.5757e-02,  3.0060e-03, -8.6328e-01, -8.0859e-01, -9.3384e-03,
          -1.7109e+00,  4.4141e-01,  9.5312e-01, -1.2500e+00, -7.4219e-01,
           2.1406e+00,  1.2256e-01, -1.5000e+00, -8.8281e-01, -3.6328e-01,
           1.0703e+00,  3.6719e+00, -1.2891e-01,  1.9434e-01, -7.0703e-01,
          -8.3984e-02, -1.7656e+00,  1.8066e-01, -9.6680e-02,  6.9922e-01,
          -3.6328e-01, -8.7280e-03, -1.3203e+00,  1.9688e+00,  1.3379e-01,
          -1.0469e+00,  6.2891e-01,  4.3945e-01,  6.5234e-01, -2.3340e-01,
          -1.1621e-01,  3.2959e-02, -7.5000e-01, -1.7480e-01,  1.7188e+00,
           7.9688e-01, -6.0938e-01,  4.6875e-01,  9.4238e-02,  1.8828e+00,
           1.0938e+00, -1.1562e+00,  8.1641e-01,  9.7266e-01, -4.9072e-02,
           9.3359e-01,  5.3516e-01, -1.2891e+00],
         [-1.2451e-01, -3.4375e-01,  2.3047e-01,  3.9844e-01,  4.0430e-01,
           2.8711e-01, -7.2656e-01, -7.2266e-01, -4.2383e-01,  5.3516e-01,
          -3.9062e-01, -5.8594e-01,  3.4570e-01, -8.5938e-01, -2.8906e-01,
          -1.4355e-01, -6.2500e-02,  5.8203e-01, -1.2012e-01, -5.0537e-02,
          -2.0801e-01, -1.1953e+00,  9.3262e-02, -1.3477e-01, -4.1748e-02,
           2.4414e-02,  1.2158e-01,  3.9844e-01,  2.0215e-01, -4.2236e-02,
           2.0500e+01, -1.1292e-02, -4.7119e-02,  1.7773e-01,  1.4258e-01,
          -4.6387e-02,  1.2812e+01,  3.7109e-02,  1.3184e-01, -1.3281e-01,
           1.7676e-01, -2.5391e-01,  1.5723e-01,  1.1328e-01, -1.5430e-01,
          -3.9307e-02, -2.3071e-02, -1.4160e-01,  1.7871e-01,  2.4902e-01,
           3.2715e-02,  1.9500e+02, -6.5918e-02, -1.9434e-01,  2.6123e-02,
          -1.5332e-01,  1.1475e-01,  3.4424e-02, -4.0039e-02,  1.2256e-01,
           3.6865e-02, -1.2012e-01,  2.6562e-01, -4.4678e-02,  2.1851e-02,
           2.1875e+00, -6.6406e-02, -5.9814e-02, -1.7969e+00,  7.6562e-01,
           6.2500e-01, -1.1094e+00, -3.1250e-01,  1.6094e+00, -8.2031e-01,
           3.3008e-01, -3.0884e-02,  1.1475e-01, -2.3828e-01,  2.0508e-02,
           1.9165e-02, -2.1094e+00, -8.6426e-02, -6.4941e-02, -1.5918e-01,
           2.7031e+00,  3.0469e-01, -2.5787e-03,  8.0078e-02,  8.9355e-02,
          -6.7969e-01, -5.4297e-01, -5.0293e-02, -6.3477e-03,  1.4219e+00,
          -4.2725e-02, -5.8838e-02,  2.0898e-01,  7.2754e-02,  1.0498e-01,
           7.6562e-01, -8.7402e-02, -1.5430e-01, -6.3171e-03,  2.2656e-01,
          -2.6611e-02,  1.2500e-01, -2.3438e-02, -9.7656e-02, -1.2793e-01,
          -1.4258e-01,  4.4678e-02, -1.4282e-02, -9.8145e-02, -1.6113e-01,
          -1.4844e-01, -2.0874e-02, -5.0000e-01,  4.2773e-01, -7.2656e-01,
          -8.3008e-02, -3.8281e-01, -4.8438e-01, -1.2500e-01,  2.0605e-01,
           8.5938e-02,  1.2793e-01,  4.6875e-01],
         [-8.5938e-01,  8.9062e-01,  1.7871e-01,  7.6953e-01,  2.3281e+00,
           5.8984e-01,  6.5234e-01,  7.4219e-01,  3.9453e-01, -1.9375e+00,
          -7.3438e-01, -8.7891e-01, -1.2109e+00, -1.7188e+00, -4.9414e-01,
           1.0840e-01,  4.7070e-01,  4.5703e-01,  6.0156e-01, -2.6367e-01,
          -7.1777e-02, -1.6172e+00,  2.7734e-01,  1.2109e+00, -6.3672e-01,
           4.6289e-01, -2.3730e-01,  1.6016e+00, -3.2715e-02, -2.3828e-01,
           1.3375e+01,  1.6895e-01, -1.2402e-01, -5.2734e-02, -4.7363e-02,
          -2.2070e-01, -1.0438e+01, -1.1658e-02, -3.2227e-01, -1.8262e-01,
           1.2402e-01, -2.2949e-01, -2.8076e-02,  1.4746e-01, -2.5024e-02,
           9.5703e-02, -5.5420e-02, -6.2012e-02, -1.2266e+00, -1.9775e-02,
          -3.6865e-02, -1.4400e+02,  3.2227e-01, -1.6968e-02, -3.0469e-01,
           8.6328e-01,  1.2354e-01, -4.9561e-02, -1.1328e-01, -6.9427e-04,
          -4.6875e-02,  5.7812e-01,  1.2402e-01,  1.5332e-01,  1.3594e+00,
          -2.4062e+00,  9.4604e-03,  9.8828e-01, -4.2188e-01,  7.8906e-01,
          -7.0703e-01, -7.3730e-02,  5.4297e-01, -8.9844e-01, -6.1279e-02,
           2.2852e-01, -9.7656e-03,  1.1719e+00,  1.0498e-01,  1.7700e-02,
           1.0078e+00, -1.3359e+00,  2.2559e-01, -1.8066e-01, -1.7676e-01,
           2.5156e+00,  1.2598e-01, -8.6328e-01, -1.9141e-01,  1.9043e-01,
           1.8848e-01, -2.5781e+00, -1.7578e-02,  2.2266e-01,  1.8828e+00,
          -6.0938e-01,  3.5156e-01, -1.5332e-01,  2.0215e-01, -2.7930e-01,
          -8.5938e-01,  2.6978e-02,  1.4844e-01, -6.0059e-02, -9.6191e-02,
           5.5469e-01, -2.0996e-01,  4.0234e-01, -9.8633e-02, -6.0303e-02,
           1.1719e-01, -1.7773e-01,  2.3340e-01, -1.6357e-02, -4.8340e-02,
          -1.1484e+00, -1.2695e-01,  3.6719e-01, -4.4336e-01,  3.0938e+00,
           3.5156e-01, -1.6992e-01, -3.6719e-01,  1.4160e-01, -3.2617e-01,
           4.3945e-01,  9.3750e-02,  2.3828e-01],
         [-4.2969e-01,  1.3047e+00,  3.5352e-01,  9.9219e-01, -2.1094e+00,
           3.3008e-01, -3.1836e-01, -1.0625e+00,  3.1494e-02,  1.5781e+00,
          -5.3516e-01, -5.8984e-01,  1.0234e+00, -1.0781e+00, -8.0469e-01,
          -1.4609e+00,  1.8652e-01,  1.5332e-01,  4.0527e-02,  3.6914e-01,
           1.2061e-01, -1.2812e+00,  7.7637e-02, -2.5156e+00, -2.7148e-01,
           5.4297e-01,  1.6504e-01,  2.9531e+00, -1.1572e-01, -2.7100e-02,
           1.0938e+01,  2.0508e-01, -1.5312e+00, -2.5391e-01,  3.2812e-01,
          -1.1250e+00, -1.0812e+01,  1.4160e-01,  1.7090e-01,  2.5391e-01,
          -4.6875e-01,  2.5391e-02, -6.7188e-01, -7.7148e-02, -1.1719e+00,
           1.4453e-01, -4.1016e-01,  3.7109e-01,  4.5938e+00,  4.7656e-01,
          -6.0938e-01,  1.1950e+02,  3.5156e-01,  6.2891e-01,  1.8652e-01,
          -3.4961e-01, -5.3125e-01, -2.4609e-01,  2.9883e-01, -5.6152e-02,
          -5.5859e-01,  2.6562e-01, -2.8809e-02,  2.3242e-01,  1.5469e+00,
          -1.8125e+00,  4.8047e-01, -2.8125e-01, -2.1057e-03, -4.5312e-01,
           7.6172e-01, -1.5312e+00, -1.2695e-01, -5.7422e-01, -2.7930e-01,
          -2.7344e-01,  7.5378e-03,  1.2578e+00, -3.8818e-02,  1.2329e-02,
          -1.9766e+00, -9.1797e-01,  4.7852e-01,  5.8594e-01,  1.3672e+00,
           2.0469e+00,  3.6914e-01,  2.0781e+00, -5.1172e-01, -4.9805e-01,
          -3.4766e-01, -3.0000e+00,  2.3828e-01, -4.2188e-01,  1.1250e+00,
          -3.2617e-01,  8.4375e-01, -1.2268e-02, -1.4453e-01, -3.1250e-01,
          -7.0312e-01,  1.6016e-01, -8.4375e-01, -3.0859e-01, -2.7148e-01,
           6.3477e-02,  4.8633e-01,  4.3457e-02, -2.3828e-01, -2.2559e-01,
          -1.1816e-01, -5.0781e-02, -1.7969e-01,  3.6328e-01,  4.0039e-01,
           2.6719e+00, -2.0898e-01,  2.4902e-01, -1.6992e-01,  6.1719e-01,
          -4.0234e-01, -1.9922e+00,  9.2969e-01, -1.1670e-01,  4.2773e-01,
          -4.8047e-01,  1.1562e+00, -2.8125e-01],
         [ 1.9629e-01,  3.1836e-01, -3.3008e-01,  3.8605e-03,  1.8359e+00,
          -4.4922e-01,  3.3984e-01, -1.0254e-01,  1.2734e+00, -1.3125e+00,
          -1.5527e-01,  1.1523e-01,  1.2207e-01, -9.6875e-01, -9.1016e-01,
          -2.5940e-03,  1.7188e-01,  5.6641e-01, -3.1445e-01, -7.5684e-02,
           5.2002e-02,  9.7656e-01, -9.3750e-02,  3.6914e-01, -2.4219e-01,
          -2.1582e-01, -2.7539e-01, -4.0430e-01,  4.1504e-02, -2.0703e-01,
           1.9750e+01,  2.6562e-01,  1.2012e-01, -9.0332e-02, -8.7402e-02,
          -1.5625e-01, -1.2188e+01,  6.2256e-02, -1.7285e-01,  1.2891e-01,
          -9.7168e-02, -2.0020e-01, -1.6895e-01, -1.2268e-02,  2.1680e-01,
          -1.5723e-01, -1.4355e-01,  1.5332e-01,  5.4297e-01, -3.9258e-01,
           5.8594e-02, -1.9100e+02, -1.8848e-01,  1.7773e-01, -6.0303e-02,
          -1.6504e-01,  6.8359e-02,  8.3160e-04, -1.1768e-01, -3.2227e-02,
           6.1279e-02,  1.4465e-02,  3.5547e-01, -1.5039e-01, -4.2188e-01,
          -1.9219e+00, -2.2363e-01,  3.6523e-01, -4.3359e-01,  3.3691e-02,
          -1.8457e-01,  5.9766e-01,  1.8359e-01,  1.1094e+00,  1.0596e-01,
          -3.0273e-02,  2.4658e-02,  5.9375e-01, -4.7070e-01,  2.6978e-02,
           4.4434e-02, -2.1562e+00, -2.4414e-01, -1.7871e-01,  7.1777e-02,
          -2.7188e+00,  2.7222e-02,  3.1250e-01,  1.0449e-01,  3.2812e-01,
          -2.6367e-01,  1.8438e+00,  6.5430e-02, -9.3262e-02,  1.2031e+00,
           6.4941e-02, -1.9727e-01,  3.2227e-01,  5.2490e-02, -2.4902e-02,
          -7.5000e-01,  2.3926e-02, -1.6797e-01,  1.4453e-01,  1.5747e-02,
           1.6016e-01, -1.2109e-01, -2.2168e-01,  1.2891e-01, -1.6895e-01,
           7.2754e-02, -3.8086e-02, -1.1035e-01,  3.1494e-02,  2.5977e-01,
          -1.4648e-01, -8.0078e-02, -5.0049e-02,  1.9379e-03, -1.0156e+00,
           1.3281e-01, -5.5908e-02,  2.1680e-01,  9.7656e-02, -3.3203e-02,
           2.2705e-02,  7.4768e-03,  2.0312e-01],
         [ 2.1719e+00, -2.7188e+00, -3.1836e-01, -1.3750e+00, -2.2969e+00,
          -1.3516e+00,  2.0801e-01,  1.1719e+00, -1.4219e+00, -1.2969e+00,
           6.6406e-01,  3.6328e-01,  4.3359e-01, -9.7266e-01,  1.1572e-01,
          -1.3086e-01, -5.1172e-01,  7.6953e-01,  5.7031e-01, -1.9434e-01,
           2.6953e-01, -1.8906e+00,  1.2305e-01, -9.6094e-01,  1.7773e-01,
           5.3906e-01,  1.5723e-01,  3.0625e+00,  3.5938e-01,  1.3770e-01,
           7.6875e+00,  9.1016e-01, -7.7344e-01, -5.7422e-01, -3.0664e-01,
          -1.0254e-02, -9.1875e+00,  5.8984e-01,  6.1328e-01, -2.2949e-02,
           1.0303e-01,  3.3398e-01,  3.2471e-02,  3.3789e-01, -3.3203e-01,
          -1.5039e-01, -2.6172e-01, -7.5684e-02, -1.6172e+00,  6.2891e-01,
          -6.7871e-02,  1.2300e+02, -5.4688e-01,  6.3965e-02,  6.1035e-03,
          -2.4023e-01, -2.2559e-01,  7.9590e-02,  2.4170e-02, -2.3828e-01,
          -2.7734e-01, -1.0938e-01,  1.2256e-01,  9.7168e-02, -4.3125e+00,
           2.0000e+00,  1.2812e+00,  1.2109e+00, -1.6504e-01,  1.2812e+00,
           3.4375e-01, -1.2031e+00,  5.9766e-01,  2.5781e-01,  2.7539e-01,
          -7.8906e-01, -1.3855e-02,  1.1719e+00,  6.4453e-01, -1.9287e-02,
           1.5198e-02, -1.6406e+00,  6.5613e-03, -2.9907e-02,  4.4531e-01,
           2.1875e+00, -4.8523e-03,  9.4922e-01,  5.7031e-01,  5.1562e-01,
           2.8906e-01, -2.9688e+00,  2.0996e-01, -8.1543e-02,  1.3984e+00,
          -2.2168e-01, -3.8672e-01,  2.1289e-01, -6.0547e-02, -4.1809e-03,
          -6.1719e-01,  2.9492e-01, -3.1641e-01, -5.5469e-01, -4.1211e-01,
           1.5723e-01, -1.8066e-02, -7.8906e-01,  3.4570e-01, -2.5586e-01,
           2.2559e-01, -2.1484e-01, -1.1768e-01, -1.7822e-02, -1.7285e-01,
           9.8828e-01,  2.4219e-01,  4.9023e-01,  2.6978e-02, -2.2812e+00,
           4.5312e-01,  1.1377e-01,  1.3184e-01,  8.9844e-02, -3.4766e-01,
           5.7812e-01,  6.2891e-01, -3.1641e-01],
         [ 2.0781e+00, -1.8828e+00,  7.7734e-01,  5.9766e-01, -1.1094e+00,
          -7.3047e-01,  8.8672e-01,  1.9766e+00, -1.1172e+00,  3.1250e-01,
          -1.9336e-01,  6.4453e-01, -1.5156e+00, -1.7578e+00,  6.1328e-01,
          -3.7891e-01,  7.6953e-01, -1.5332e-01,  7.6953e-01, -1.3672e+00,
           6.9531e-01, -1.3281e+00, -8.3203e-01,  6.1328e-01, -1.2734e+00,
          -1.3828e+00, -7.4219e-02,  9.0625e-01, -3.1836e-01, -8.8672e-01,
           9.3750e+00,  4.5898e-01, -1.1562e+00, -2.7344e-02,  8.0078e-02,
          -1.3281e+00, -8.4375e+00,  1.6699e-01, -8.6328e-01,  6.7188e-01,
          -9.2285e-02,  1.2402e-01, -5.8203e-01,  1.2578e+00,  1.1768e-01,
           4.7461e-01, -3.2031e-01, -3.5352e-01,  1.8047e+00, -3.6133e-01,
          -4.3359e-01, -1.2700e+02, -2.8320e-01,  2.2031e+00,  4.9219e-01,
           1.9824e-01,  3.4531e+00,  4.0625e-01, -1.5000e+00,  8.7891e-02,
           2.5312e+00,  3.2188e+00, -3.8594e+00, -6.6406e-01, -1.8828e+00,
          -1.7109e+00,  1.3438e+00, -3.6523e-01, -2.9062e+00, -3.2031e-01,
          -2.4609e-01,  2.5156e+00,  4.4336e-01, -6.4844e-01, -1.8906e+00,
          -1.3828e+00, -1.0437e-02, -1.1250e+00,  9.1016e-01, -1.1658e-02,
          -9.3359e-01,  2.1562e+00,  9.5312e-01, -6.5625e-01,  8.1055e-02,
           3.0938e+00,  1.1016e+00, -6.1279e-02,  1.1172e+00,  1.4343e-02,
          -6.7383e-02, -4.4375e+00, -1.5332e-01,  4.0283e-02,  4.2188e-01,
           1.6719e+00,  1.0547e+00,  1.6797e-01,  1.9043e-02, -4.7656e-01,
          -5.7422e-01, -1.8652e-01, -9.4727e-02,  2.7812e+00,  2.6758e-01,
           2.8320e-01,  8.5938e-01, -1.0303e-01, -2.4414e-02, -1.7383e-01,
          -1.2256e-01, -2.0020e-01, -2.6172e-01,  6.7578e-01, -3.8086e-01,
           1.8750e-01,  1.6895e-01,  1.8516e+00,  1.4551e-01, -2.5391e-01,
          -9.9219e-01,  4.1602e-01, -4.0312e+00, -1.5781e+00,  4.4375e+00,
          -4.3438e+00,  8.1250e-01,  1.1484e+00],
         [ 1.5198e-02, -1.8359e-01, -1.9238e-01,  1.9165e-02, -1.1797e+00,
          -6.2109e-01,  1.7773e-01, -6.5234e-01,  4.5312e-01, -5.3516e-01,
          -5.5469e-01,  5.3516e-01, -5.0293e-02,  6.2500e-01, -1.1670e-01,
          -8.5449e-03, -1.7773e-01, -7.8906e-01,  5.5847e-03, -7.6172e-02,
          -1.4648e-01, -9.1406e-01,  4.2188e-01, -3.6328e-01,  3.7842e-02,
           3.9648e-01,  6.0547e-02, -5.3516e-01,  4.1211e-01,  5.0293e-02,
          -1.8625e+01, -1.2793e-01,  2.0020e-01, -3.2227e-02,  2.0874e-02,
           3.3936e-02, -1.2688e+01, -1.4746e-01, -1.0620e-02, -5.3955e-02,
          -1.6504e-01,  5.9326e-02, -6.3171e-03, -3.9551e-02,  1.5747e-02,
          -1.2402e-01, -3.1250e-01,  4.3213e-02, -1.0391e+00,  5.7422e-01,
           1.6602e-01,  1.7800e+02, -3.6523e-01,  4.1260e-02, -1.8921e-02,
          -1.0400e-01,  2.2070e-01, -5.1880e-03, -6.1035e-02, -6.0791e-02,
           1.2695e-01,  8.2031e-02, -1.6968e-02,  7.8735e-03,  1.9727e-01,
           2.0781e+00, -3.0859e-01, -2.0020e-01, -1.1094e+00,  4.5703e-01,
           6.4453e-02, -1.0078e+00, -2.3340e-01, -1.2188e+00,  5.1172e-01,
           4.1602e-01,  2.4109e-03, -1.2578e+00, -1.7773e-01,  2.7954e-02,
          -3.6523e-01,  2.1562e+00, -3.0078e-01,  2.0020e-01,  1.2695e-01,
           2.7500e+00,  1.6699e-01,  2.5586e-01,  1.2589e-03, -1.6504e-01,
           5.1953e-01,  2.0781e+00,  9.7656e-02, -1.6211e-01, -1.5234e+00,
           8.3496e-02,  1.0693e-01,  9.8633e-02, -3.8818e-02, -4.1797e-01,
          -6.9531e-01,  1.3770e-01,  1.4355e-01, -2.2949e-01, -2.6953e-01,
          -1.4160e-01,  9.6680e-02, -1.0547e-01,  5.3955e-02, -2.2168e-01,
           1.3281e-01, -3.4912e-02, -1.6479e-02, -1.6602e-01,  2.9688e-01,
          -1.3855e-02,  2.2168e-01,  9.1553e-03, -2.6562e-01,  4.4336e-01,
          -5.8838e-02, -9.8633e-02,  4.1797e-01,  8.0566e-02, -2.8687e-02,
           2.7539e-01,  1.9336e-01,  1.2988e-01]]], device='cuda:0',
       dtype=torch.bfloat16)

logits2 = torch.tensor([[[-4.9062e+00,  2.3281e+00,  1.8125e+00,  3.3594e+00, -5.3750e+00,
           7.8613e-02,  5.6250e-01,  2.1094e+00,  6.7578e-01, -7.3828e-01,
          -1.7422e+00,  1.3906e+00,  8.1641e-01,  1.0859e+00,  3.7109e-02,
           1.8848e-01, -5.3906e-01, -2.1484e-01,  7.1875e-01, -1.4922e+00,
           5.5859e-01, -1.1328e+00, -5.9375e-01,  2.6250e+00,  1.2695e-01,
           6.6406e-01, -2.5977e-01, -2.5312e+00,  1.4160e-01, -1.1016e+00,
          -9.9375e+00, -1.1172e+00,  1.3672e+00,  5.7812e-01,  2.9688e-01,
          -4.0234e-01, -8.7500e+00,  2.1094e-01,  9.0625e-01,  1.4531e+00,
           7.4609e-01, -7.1875e-01, -3.9062e-01, -6.6016e-01,  7.9688e-01,
           4.8047e-01,  3.4375e-01,  1.8945e-01,  9.6094e-01,  2.0020e-02,
           3.3008e-01, -1.1500e+02,  2.0752e-02,  5.9766e-01,  8.3594e-01,
          -8.4473e-02, -6.5625e-01, -6.0156e-01, -4.7070e-01,  6.4062e-01,
           1.0781e+00,  4.2383e-01,  7.2266e-01,  1.4844e+00,  5.3125e+00,
          -4.8438e+00,  2.8594e+00, -6.3672e-01, -1.2578e+00,  8.0078e-01,
          -1.0078e+00, -9.6094e-01, -1.2031e+00,  6.4453e-01,  1.5234e+00,
          -2.4414e-02,  9.7275e-04, -8.7500e-01, -7.2656e-01, -6.4392e-03,
          -1.9609e+00,  5.4297e-01,  1.1250e+00, -9.9219e-01, -8.1250e-01,
           2.2656e+00, -4.3213e-02, -1.6172e+00, -9.4141e-01, -3.2227e-01,
           1.0312e+00,  3.4844e+00, -1.7285e-01,  2.3242e-01, -7.8516e-01,
          -2.4121e-01, -1.7344e+00,  7.5073e-03, -1.1780e-02,  7.1094e-01,
          -2.9688e-01, -8.5938e-02, -1.4375e+00,  2.1250e+00,  2.5391e-01,
          -9.5312e-01,  6.2500e-01,  3.7500e-01,  4.0430e-01, -1.5527e-01,
          -1.4282e-02,  3.3936e-02, -7.2656e-01, -3.8086e-02,  1.9375e+00,
           7.0312e-01, -5.8203e-01,  6.5625e-01,  2.8906e-01,  2.1406e+00,
           9.1797e-01, -1.0781e+00,  1.3438e+00,  1.0078e+00,  2.2461e-01,
           8.2812e-01,  6.3281e-01, -1.5781e+00],
         [-4.9561e-02, -2.4707e-01,  2.9492e-01,  4.1016e-01,  3.2422e-01,
           3.7305e-01, -5.6641e-01, -5.9766e-01, -5.2734e-01,  7.9688e-01,
          -3.9062e-01, -4.2578e-01,  2.5977e-01, -9.7266e-01, -3.6133e-01,
          -5.1025e-02,  3.1494e-02,  6.1719e-01, -1.3977e-02,  4.3701e-02,
           5.8350e-02, -1.2891e+00,  1.8555e-01, -2.2461e-01,  4.4678e-02,
           2.1118e-02,  3.8330e-02,  4.0039e-01,  1.5820e-01,  3.1250e-02,
           1.9875e+01,  1.4941e-01,  1.6602e-02, -1.1377e-01,  3.7354e-02,
          -1.1816e-01,  1.2438e+01, -2.6978e-02,  1.6797e-01, -7.0190e-03,
          -4.5898e-02, -1.8457e-01,  1.6699e-01, -1.0449e-01,  4.0039e-02,
           3.7079e-03, -5.6763e-03,  4.7913e-03,  8.3594e-01, -4.0771e-02,
           5.5908e-02,  1.8700e+02,  4.0039e-02, -1.5332e-01,  1.1133e-01,
          -6.2256e-02,  8.7402e-02,  2.7466e-02, -1.3965e-01, -4.4434e-02,
           4.2480e-02,  1.3867e-01,  3.6914e-01, -2.7930e-01,  4.1260e-02,
           2.0625e+00, -2.3926e-01,  2.3145e-01, -1.7734e+00,  6.1328e-01,
           5.2344e-01, -9.1797e-01, -2.5195e-01,  1.4609e+00, -9.5312e-01,
           2.7539e-01, -3.0029e-02,  2.8125e-01, -6.9336e-02,  1.2024e-02,
           1.1670e-01, -2.1719e+00, -9.5703e-02,  8.9355e-02, -1.1865e-01,
           2.7344e+00,  5.2979e-02, -1.2305e-01,  6.6406e-02,  2.0117e-01,
          -4.2969e-01, -6.5234e-01, -9.1797e-02, -1.0938e-01,  1.5859e+00,
           4.6143e-02,  2.0703e-01,  5.7617e-02, -1.6968e-02,  1.9434e-01,
           8.4766e-01, -6.2500e-02, -7.4219e-02, -1.9922e-01,  5.6152e-02,
           2.0874e-02,  1.5625e-01, -1.9043e-01, -3.9795e-02, -2.9688e-01,
          -1.6699e-01, -1.4941e-01, -1.2793e-01, -1.7944e-02, -3.9648e-01,
          -8.0566e-02,  1.0010e-01, -5.8984e-01,  3.3203e-01, -7.8906e-01,
           1.0742e-01, -2.6367e-01, -6.4062e-01,  4.6387e-03,  1.6113e-01,
           6.1035e-02,  1.3672e-01,  4.9219e-01],
         [-9.1406e-01,  7.2266e-01,  3.0664e-01,  5.5859e-01,  2.4375e+00,
           8.9453e-01,  6.1328e-01,  6.8750e-01,  3.7500e-01, -2.0156e+00,
          -8.5156e-01, -9.8047e-01, -1.3594e+00, -1.8594e+00, -6.0156e-01,
           3.8867e-01,  6.4062e-01,  4.2383e-01,  7.6172e-01, -3.6914e-01,
          -2.9419e-02, -1.6172e+00,  4.1016e-01,  1.4062e+00, -5.3906e-01,
           5.4688e-01, -4.0039e-01,  1.5547e+00, -6.1646e-03, -2.0801e-01,
           1.3125e+01,  6.5918e-02, -3.2715e-02,  1.3574e-01,  1.0986e-01,
          -1.1621e-01, -1.1062e+01, -6.0791e-02, -3.3984e-01, -2.2168e-01,
          -3.3112e-03, -1.0498e-01, -6.1035e-02,  8.6426e-02,  6.6406e-02,
           1.8652e-01,  4.0039e-02, -1.9043e-01, -1.2422e+00, -1.7578e-01,
           2.0142e-02, -1.4300e+02,  1.5625e-01, -3.5400e-02, -2.5586e-01,
           7.2656e-01,  1.0986e-01, -4.5898e-02, -1.8311e-02, -1.8164e-01,
          -9.0820e-02,  5.5859e-01,  5.8838e-02,  1.8555e-01,  1.7500e+00,
          -2.4688e+00, -3.4375e-01,  8.1250e-01, -4.9219e-01,  7.6562e-01,
          -7.6562e-01, -1.0010e-01,  6.5625e-01, -9.1797e-01, -2.1582e-01,
           1.6211e-01, -5.0049e-03,  1.3594e+00,  1.8066e-01,  1.2268e-02,
           1.0156e+00, -1.2266e+00,  1.6406e-01, -3.0859e-01, -2.9102e-01,
           2.9688e+00,  3.3594e-01, -8.8281e-01, -1.5332e-01,  3.4570e-01,
           3.8086e-02, -2.2969e+00,  5.9082e-02,  2.8516e-01,  1.8516e+00,
          -2.5977e-01, -8.1055e-02, -1.4746e-01,  1.4062e-01, -3.3398e-01,
          -8.5938e-01, -6.3477e-02,  1.7383e-01, -8.6426e-02, -1.5332e-01,
           3.5938e-01, -8.6914e-02,  5.4688e-01, -1.1719e-01, -7.7637e-02,
           1.5723e-01, -8.8867e-02,  8.4473e-02,  3.5889e-02,  1.2988e-01,
          -1.1953e+00, -1.2793e-01,  2.8125e-01, -1.7969e-01,  3.2031e+00,
           4.8047e-01,  3.6621e-02, -5.7031e-01, -1.4221e-02, -8.3008e-02,
           4.3750e-01,  1.4893e-02,  4.1748e-02],
         [-5.5469e-01,  1.0938e+00,  2.4414e-01,  1.2891e+00, -1.8906e+00,
           4.9219e-01, -2.9688e-01, -9.5312e-01,  1.8188e-02,  1.5625e+00,
          -8.3594e-01, -4.3359e-01,  7.8125e-01, -1.0391e+00, -7.9297e-01,
          -1.5938e+00,  3.0664e-01,  1.7383e-01,  1.2402e-01,  2.9688e-01,
           4.7852e-02, -1.1953e+00,  1.0449e-01, -2.6250e+00, -2.0703e-01,
           4.4531e-01,  1.1035e-01,  2.7344e+00, -2.0996e-01,  1.0791e-01,
           9.9375e+00,  4.3457e-02, -1.7734e+00, -2.1484e-01,  5.0781e-01,
          -1.2188e+00, -9.6875e+00,  7.8125e-02,  1.0840e-01,  4.7070e-01,
          -4.0820e-01, -1.6602e-01, -6.3672e-01, -1.0498e-01, -1.1953e+00,
           1.3184e-01, -2.9688e-01,  8.1250e-01,  4.8438e+00, -8.4839e-03,
          -7.3828e-01,  1.0850e+02,  7.3047e-01,  6.4062e-01,  2.8320e-01,
          -4.6680e-01, -5.6250e-01, -3.3398e-01,  3.5352e-01, -5.8838e-02,
          -5.9375e-01,  6.2109e-01, -2.3145e-01,  1.9629e-01,  1.7422e+00,
          -1.8438e+00,  6.4453e-01, -1.2256e-01,  3.8574e-02, -2.7148e-01,
           5.2734e-01, -1.6562e+00,  5.5176e-02, -5.8203e-01, -1.2158e-01,
          -2.5977e-01,  1.3367e-02,  1.3672e+00, -2.0605e-01,  1.5015e-02,
          -1.8203e+00, -9.6484e-01,  6.0547e-01,  5.5859e-01,  9.6484e-01,
           2.2500e+00,  1.5332e-01,  1.8125e+00, -2.7148e-01, -3.7891e-01,
          -5.9375e-01, -2.5312e+00,  1.7383e-01, -3.9648e-01,  1.2188e+00,
          -4.5703e-01,  4.6484e-01, -3.8086e-01, -3.7994e-03, -7.9297e-01,
          -6.5625e-01,  2.0605e-01, -7.6953e-01, -6.4062e-01, -2.3242e-01,
           2.2559e-01,  6.2891e-01, -2.7344e-01, -3.8477e-01, -5.0781e-01,
          -2.7344e-01, -4.3213e-02, -1.1914e-01,  2.8711e-01,  2.8711e-01,
           2.5625e+00, -2.9297e-01,  1.3477e-01, -9.5312e-01, -1.1562e+00,
          -3.1250e-01, -1.5312e+00,  6.9141e-01, -3.4790e-03,  5.2344e-01,
          -4.3555e-01,  1.1641e+00, -5.5078e-01],
         [-2.5000e-01,  2.0117e-01, -2.3047e-01, -1.2109e-01,  2.2031e+00,
          -3.8672e-01,  2.2266e-01,  7.7637e-02,  9.1797e-01, -1.4453e+00,
          -1.7285e-01,  9.8145e-02,  1.1572e-01, -8.4375e-01, -1.0234e+00,
           2.0117e-01,  1.5039e-01,  5.7812e-01, -2.7539e-01,  9.8267e-03,
          -1.1475e-02,  1.0391e+00, -1.0156e-01,  5.5469e-01, -1.4648e-01,
          -1.9922e-01, -2.5391e-01, -2.9883e-01,  1.0156e-01, -1.9336e-01,
           2.0375e+01, -4.0039e-02,  2.0605e-01,  5.6641e-02, -5.1270e-02,
          -1.1279e-01, -1.2750e+01, -6.3965e-02, -1.0645e-01, -1.6602e-01,
          -6.2988e-02, -2.2217e-02, -7.0801e-02,  2.5024e-02,  7.5195e-02,
           4.7852e-02, -1.1670e-01, -1.5564e-02,  6.0547e-01, -3.6133e-01,
           1.5527e-01, -1.9500e+02, -1.3184e-01,  1.0645e-01,  4.3945e-02,
          -2.5586e-01,  1.1133e-01,  6.7871e-02, -2.5757e-02, -2.0020e-01,
          -2.1362e-02,  3.6621e-02,  2.7539e-01,  1.9897e-02, -1.0547e+00,
          -1.8984e+00, -1.0693e-01,  3.9844e-01, -5.0781e-01,  2.4512e-01,
          -3.1055e-01,  4.3945e-01,  1.3477e-01,  1.3594e+00,  2.4609e-01,
           5.9082e-02,  1.5991e-02,  6.4844e-01, -5.6641e-01,  3.0273e-02,
           1.8457e-01, -2.3594e+00, -1.8457e-01, -1.1328e-01,  2.3315e-02,
          -2.8594e+00, -6.7520e-04,  2.8125e-01,  5.8838e-02,  2.1484e-01,
          -2.4414e-01,  1.8828e+00,  1.2305e-01, -2.4121e-01,  1.2266e+00,
           1.6504e-01, -1.8359e-01,  2.9297e-02,  1.6113e-01,  9.4727e-02,
          -7.4609e-01,  2.9663e-02, -1.3672e-01, -2.6245e-02, -9.0820e-02,
           8.7891e-02,  5.5908e-02, -2.5146e-02,  3.7598e-02, -5.4688e-02,
           1.1914e-01,  6.7749e-03, -9.1797e-02,  1.8677e-02,  3.3398e-01,
          -1.7188e-01, -1.0010e-01, -1.0400e-01,  1.6797e-01, -1.1016e+00,
          -9.7656e-02, -1.4343e-02,  3.6719e-01,  2.6953e-01, -1.6992e-01,
           2.2168e-01, -8.6426e-02,  9.4727e-02],
         [ 1.7344e+00, -2.5625e+00, -3.5156e-01, -1.3047e+00, -2.5000e+00,
          -1.0781e+00,  4.7461e-01,  1.6094e+00, -1.5156e+00, -1.4062e+00,
           4.0039e-01,  7.5684e-02,  3.8867e-01, -1.2578e+00, -1.5918e-01,
          -2.1387e-01, -5.8594e-01,  7.6953e-01,  4.3750e-01, -9.9121e-02,
           3.4961e-01, -1.9219e+00,  1.8457e-01, -1.0938e+00,  1.6992e-01,
           5.2734e-01,  1.0303e-01,  3.3438e+00,  3.3008e-01,  1.3379e-01,
           6.4062e+00,  5.6641e-01, -7.6172e-01, -4.1406e-01, -6.2012e-02,
           7.4707e-02, -8.6250e+00,  4.0234e-01,  8.2812e-01,  1.1414e-02,
           1.5723e-01,  1.8555e-01,  2.1289e-01,  2.9102e-01, -1.8066e-01,
           7.0801e-02, -1.9238e-01, -1.3574e-01, -2.0156e+00,  7.9956e-03,
          -1.0742e-01,  1.1550e+02, -5.0391e-01,  1.1328e-01,  1.1292e-02,
          -2.6562e-01, -2.3340e-01,  1.8359e-01,  1.5234e-01, -9.7168e-02,
          -1.5723e-01, -4.5117e-01,  1.5332e-01,  1.4355e-01, -3.8438e+00,
           2.1719e+00,  1.4922e+00,  1.3359e+00, -2.2266e-01,  1.1172e+00,
           1.2598e-01, -1.1406e+00,  4.3359e-01,  2.1094e-01,  4.0039e-02,
          -7.3047e-01, -1.3672e-02,  1.2109e+00,  6.3672e-01, -1.8677e-02,
           5.7861e-02, -1.5312e+00,  1.1572e-01, -1.6406e-01,  4.5898e-01,
           2.0625e+00, -2.2363e-01,  1.1562e+00,  4.9023e-01,  3.3594e-01,
           1.9629e-01, -2.8750e+00,  2.9102e-01, -1.4746e-01,  1.3438e+00,
          -3.4180e-03, -4.6094e-01,  2.2461e-01, -1.7212e-02, -4.1504e-03,
          -6.4062e-01,  2.2949e-01, -4.5312e-01, -6.0547e-01, -5.4297e-01,
           1.8945e-01,  1.7334e-02, -8.9844e-01,  3.8477e-01, -2.4414e-01,
           3.0078e-01, -2.6562e-01, -3.9062e-02,  1.1963e-02, -1.8457e-01,
           1.2422e+00,  2.5195e-01,  7.4609e-01,  2.2461e-02, -2.7812e+00,
           6.1328e-01,  1.0107e-01,  1.2988e-01,  5.0391e-01, -6.0156e-01,
           6.7188e-01,  7.4219e-01, -1.9043e-01],
         [ 1.4922e+00, -1.8594e+00,  1.0391e+00,  5.5078e-01, -1.5859e+00,
          -7.0312e-01,  8.7891e-01,  2.1094e+00, -1.0469e+00,  2.6367e-01,
          -4.2773e-01,  7.1484e-01, -1.5312e+00, -1.7891e+00,  4.7852e-01,
          -4.3555e-01,  6.7969e-01, -1.3477e-01,  8.9062e-01, -1.3047e+00,
           5.7031e-01, -1.3672e+00, -7.6953e-01,  8.2812e-01, -1.2266e+00,
          -1.1250e+00, -2.1875e-01,  1.1172e+00, -3.5547e-01, -8.4766e-01,
           9.8125e+00,  3.8281e-01, -1.3594e+00,  7.2266e-02,  2.3242e-01,
          -1.2578e+00, -8.4375e+00,  2.0703e-01, -8.2812e-01,  6.5625e-01,
           1.3477e-01,  1.7480e-01, -6.0938e-01,  1.3047e+00,  2.6489e-02,
           4.7266e-01, -2.0410e-01, -4.4336e-01,  2.1250e+00, -9.0332e-02,
          -3.6133e-01, -1.2750e+02, -7.6953e-01,  2.0469e+00,  4.9805e-01,
           3.1641e-01,  3.5156e+00,  3.4570e-01, -1.3750e+00,  4.9023e-01,
           2.6094e+00,  3.2344e+00, -3.7656e+00, -5.1953e-01, -1.9453e+00,
          -1.1406e+00,  1.6172e+00, -2.2754e-01, -2.6719e+00, -2.3535e-01,
          -3.5938e-01,  2.3438e+00,  4.7266e-01, -7.8516e-01, -2.1250e+00,
          -1.5000e+00, -1.3611e-02, -1.1953e+00,  8.0469e-01, -1.1108e-02,
          -1.1250e+00,  2.1719e+00,  1.1406e+00, -5.3906e-01,  7.3242e-02,
           3.1719e+00,  1.2266e+00,  4.5410e-02,  1.1250e+00,  1.8750e-01,
          -5.7129e-02, -4.2812e+00, -1.6406e-01,  9.3750e-02,  5.2734e-01,
           1.6719e+00,  9.9219e-01,  1.6968e-02,  1.6895e-01, -3.7891e-01,
          -5.8594e-01,  2.3804e-02, -1.6016e-01,  2.9531e+00,  2.1777e-01,
           1.2988e-01,  6.8750e-01,  1.8799e-02, -1.1768e-01, -4.4189e-02,
          -1.4648e-01, -6.7871e-02, -3.2031e-01,  6.1719e-01, -4.5312e-01,
           4.4189e-02,  1.0693e-01,  1.7578e+00, -4.1260e-02,  5.3516e-01,
          -9.1797e-01,  3.8477e-01, -4.5625e+00, -1.6016e+00,  4.4062e+00,
          -4.2188e+00,  4.8047e-01,  1.2031e+00],
         [ 1.0205e-01, -1.3281e-01, -3.1836e-01, -6.1035e-02, -1.3047e+00,
          -7.5391e-01, -1.3086e-01, -5.7422e-01,  5.5078e-01, -5.4688e-01,
          -2.4512e-01,  4.7070e-01, -3.7109e-01,  5.5469e-01, -1.5625e-01,
          -5.2490e-02, -5.1758e-02, -8.4766e-01,  1.3379e-01,  8.3008e-02,
          -9.4727e-02, -9.5703e-01,  4.6484e-01, -2.5586e-01,  3.4424e-02,
           3.0859e-01,  2.4707e-01, -3.7109e-01,  2.6758e-01, -6.5613e-03,
          -1.8375e+01, -1.4771e-02,  4.0771e-02, -2.3340e-01,  1.2793e-01,
          -5.3711e-02, -1.2125e+01, -7.9590e-02, -9.0820e-02,  8.6426e-02,
          -1.0205e-01, -8.8379e-02,  1.0938e-01,  1.3123e-02,  2.0264e-02,
          -1.5332e-01, -1.5918e-01,  3.1006e-02, -1.4766e+00,  1.2402e-01,
          -4.9561e-02,  1.7300e+02, -1.2158e-01, -5.4199e-02,  8.3618e-03,
          -2.6245e-02,  3.2812e-01, -9.8633e-02,  8.0566e-03, -7.2266e-02,
           8.2520e-02,  4.0625e-01,  1.9336e-01, -2.1680e-01, -5.8594e-02,
           2.0156e+00, -1.8555e-01, -1.5430e-01, -1.1641e+00,  4.3164e-01,
           2.4316e-01, -9.3359e-01, -2.5391e-01, -1.2188e+00,  4.5703e-01,
           2.2461e-01, -6.0425e-03, -1.4219e+00, -2.8320e-01,  3.0640e-02,
          -2.4219e-01,  2.1406e+00, -4.3555e-01,  3.0029e-02,  1.0449e-01,
           2.6406e+00, -3.5095e-03,  2.1362e-02,  1.0840e-01, -2.4121e-01,
           5.1562e-01,  2.1875e+00,  1.3867e-01, -1.6699e-01, -1.6875e+00,
           6.0059e-02, -1.4844e-01, -2.8564e-02,  6.7383e-02, -5.1025e-02,
          -7.3438e-01,  1.7676e-01,  8.5938e-02, -1.7383e-01, -1.4941e-01,
          -2.8516e-01,  8.8379e-02,  1.0303e-01,  1.1963e-01, -3.2227e-02,
          -6.3477e-02,  9.4727e-02,  7.0312e-02, -6.4453e-02,  1.0986e-01,
           9.9121e-02,  2.2754e-01, -1.4160e-01, -2.0703e-01,  3.3203e-01,
          -1.3477e-01, -2.3193e-02, -1.0059e-01,  4.5166e-02, -1.3281e-01,
           1.9727e-01,  9.6191e-02,  9.4727e-02]]], device='cuda:0',
       dtype=torch.bfloat16)

import torch
import torch.nn.functional as F

print("Shape:", logits1.shape, logits2.shape)
assert logits1.shape == logits2.shape

B, H, D = logits1.shape
logits1 = logits1.float()
logits2 = logits2.float()

print("\n=== 1. Global Similarity ===")
l1_dist = torch.norm(logits1 - logits2, p=1) / logits1.numel()
l2_dist = torch.norm(logits1 - logits2, p=2) / logits1.numel()
cos_sim = F.cosine_similarity(logits1.view(-1), logits2.view(-1), dim=0)

print(f"L1 diff per element: {l1_dist:.4f}")
print(f"L2 diff per element: {l2_dist:.4f}")
print(f"Cosine similarity:   {cos_sim:.4f}")

print("\n=== 2. Distribution Stats ===")
def stats(t, name):
    print(f"{name}: mean={t.mean():.3f}, std={t.std():.3f}, min={t.min():.3f}, max={t.max():.3f}")

stats(logits1, "logits1")
stats(logits2, "logits2")

print("\n=== 3. Per-Head Similarity (dim=1) ===")
for h in range(H):
    cos_h = F.cosine_similarity(logits1[0, h], logits2[0, h], dim=0)
    l1_h = torch.abs(logits1[0, h] - logits2[0, h]).mean()
    print(f"Head {h:2d}: cos={cos_h:.3f}, L1={l1_h:.3f}")

print("\n=== 4. Per-Feature (D-dim) L1 diff ===")
l1_per_feat = torch.abs(logits1 - logits2).mean(dim=[0, 1])  # [D]
top5_diff_idx = torch.topk(l1_per_feat, 5, largest=True).indices
print("Top-5 most different feature indices:", top5_diff_idx.tolist())
print("Their avg L1 diffs:", l1_per_feat[top5_diff_idx].tolist())

print(f"\nFeature #30 (index=30) L1 diff: {l1_per_feat[30]:.3f}")
print(f"logits1[:, :, 30].flatten(): {logits1[:, :, 30].flatten()}")
print(f"logits2[:, :, 30].flatten(): {logits2[:, :, 30].flatten()}")

eps = 1e-8
tau = 0.5  
use_softmax = False  

z1_soft = torch.sigmoid(logits1 / tau)
z2_soft = torch.sigmoid(logits2 / tau)

print("\n=== 5. z_soft (τ=0.5, no Gumbel noise) ===")
print(f"z1_soft mean: {z1_soft.mean():.4f} ± {z1_soft.std():.4f}")
print(f"z2_soft mean: {z2_soft.mean():.4f} ± {z2_soft.std():.4f}")
print(f"z1_soft vs z2_soft L1 diff (per element): {torch.abs(z1_soft - z2_soft).mean():.5f}")

# Per-head mean z
z1_head_mean = z1_soft.mean(dim=-1)  # [B, H]
z2_head_mean = z2_soft.mean(dim=-1)
print("\nPer-head z_soft mean:")
for h in range(H):
    print(f"  Head {h}: z1={z1_head_mean[0, h]:.3f}, z2={z2_head_mean[0, h]:.3f}, diff={abs(z1_head_mean[0, h]-z2_head_mean[0, h]):.3f}")

# === Step 6: Simulate with Gumbel (1 sample) to see z_hard mismatch rate ===
torch.manual_seed(42)
u = torch.rand_like(logits1)
g = -torch.log(-torch.log(u + eps) + eps)
z1_sample = torch.sigmoid((logits1 + g) / tau)
z2_sample = torch.sigmoid((logits2 + g) / tau)  # same g for fair compare

z1_hard = (z1_sample > 0.5).float()
z2_hard = (z2_sample > 0.5).float()

mismatch = (z1_hard != z2_hard).float().mean()
mismatch_per_head = (z1_hard != z2_hard).float().mean(dim=[0, 2])  # [H]

print(f"\n=== 6. z_hard mismatch (1 noise sample, same g) ===")
print(f"Overall mismatch rate: {mismatch:.3%}")
for h in range(H):
    print(f"  Head {h}: mismatch={mismatch_per_head[h]:.3%}")

# Highlight heads with >30% mismatch
high_mismatch_heads = torch.where(mismatch_per_head > 0.3)[0].tolist()
if high_mismatch_heads:
    print(f"\n⚠️ Heads with high mismatch: {high_mismatch_heads}")
    print("Check their logits distributions (especially extreme values)")